story_id: "2.5"
story_title: "学校管理员账号管理"
review_date: "2026-02-09"
reviewer: "JW (QA Engineer)"
review_round: 1

gate_result: PASS
next_status: Done

risk_assessment:
  risk_level: MEDIUM
  review_mode: deep_code_review
  complexity_indicators: 3
  security_sensitive: false
  notes: "Standard tier; fullstack CRUD — new school options API + admin list page with search/filter/create; role-based frontend guard (meta.roles=[1]); cross backend+frontend"

project_type:
  type: web_fullstack
  subtype: crud_management_page
  test_runner: code_review_plus_typescript_check

automated_tests:
  verification_method: file_validation_plus_deep_code_review
  total_checks: 38
  passed: 38
  failed: 0
  pass_rate: 100%
  categories:
    file_existence: 14/14
    deliverable_bindings: 8/8
    task_checkboxes: 38/38

deep_file_review:
  new_files_reviewed: 8
  modified_files_reviewed: 6
  total: 14
  categories:
    backend_dto: 1/1
    backend_mapper: 1/1
    backend_service: 1/1
    backend_service_impl: 1/1
    backend_controller: 1/1
    frontend_api_admin_user: 1/1
    frontend_api_school: 1/1
    frontend_page: 1/1
    frontend_routes: 1/1
    frontend_guards: 1/1
    frontend_sidebar: 1/1
    frontend_types_model: 1/1
    frontend_types_api: 1/1
    frontend_types_router: 1/1

backend_review:
  school_option_response:
    fields: "id(Long), name(String)"
    lombok: "@Data"
    minimal: "PASS — no extra fields"
  school_mapper:
    annotation: "@Mapper"
    sql: "SELECT id, name FROM schools WHERE status = 1 AND deleted_at IS NULL ORDER BY sort_order"
    sql_injection: "PASS — static query, no dynamic interpolation"
    return_type: "List<SchoolOptionResponse>"
  school_service:
    interface: "listOptions() → List<SchoolOptionResponse>"
  school_service_impl:
    annotation: "@Service + @RequiredArgsConstructor"
    implements: "SchoolService"
    injection: "SchoolMapper via constructor"
    delegation: "schoolMapper.listOptions()"
  school_controller:
    annotations: "@RestController + @RequestMapping('/v1/schools') + @Tag('学校管理') + @RequiredArgsConstructor"
    endpoint: "GET /v1/schools/options"
    operation: "@Operation(summary='获取学校选项列表')"
    return_type: "Result<List<SchoolOptionResponse>>"
    injection: "SchoolService via constructor"

frontend_page_review:
  list_display:
    columns: "账号(username), 所属学校(schoolName mapping), 状态(el-tag), 最后登录时间(formatted)"
    default_role: "role=2 hardcoded in query"
    school_name_mapping: "PASS — getSchoolName(row.schoolId) from cached schoolOptions"
    status_tags: "PASS — status===1 type='success' '启用', else type='danger' '禁用'"
    time_format: "PASS — YYYY-MM-DD HH:mm, null shows '—'"
    pagination: "PASS — page-sizes=[10,20,50,100], layout includes 'total'"
    empty_state: "PASS — el-empty v-if !loading && tableData.length===0"
    defaults: "page=1, size=10"

  phone_search:
    placeholder: "请输入手机号搜索"
    button_trigger: "PASS — @click='handleSearch'"
    enter_trigger: "PASS — @keyup.enter='handleSearch'"
    clear_trigger: "PASS — clearable + @clear='handleSearch'"
    page_reset: "PASS — queryParams.page=1 before fetchList()"

  school_filter:
    component: "el-select with clearable"
    placeholder: "全部学校"
    options_loaded: "PASS — onMounted → fetchSchoolOptions()"
    change_trigger: "PASS — @change='handleSearch'"
    combinable: "PASS — keyword + schoolId sent independently"

  create_dialog:
    button: "新增管理员"
    dialog_title: "新增管理员"
    fields: "username (phone input) + schoolId (school select) — NO name field"
    role_injection: "PASS — role=2 in createForm, not shown"
    phone_regex: "^1[3-9]\\d{9}$"
    school_required: "PASS — required validation"
    success_message: "创建成功，默认密码为手机号后6位"
    cancel_reset: "PASS — dialog close triggers resetForm"
    no_password_field: "PASS — create form and table have NO password"

routing_review:
  route_entry: "/admin-users"
  route_meta: "title='管理员管理', requiresAuth=true, layout='main', roles=[1]"
  lazy_loaded: "PASS — () => import('@/views/admin-users/index.vue')"
  guard_roles_check: "PASS — to.meta.roles && !roles.includes(user.role) → redirect /dashboard"
  guard_order: "PASS — isLoggedIn → isFirstLogin → meta.roles → normal"
  sidebar_menu: "PASS — v-if='authStore.isSuperAdmin', User icon, index='/admin-users'"

type_review:
  admin_user_list_item: "PASS — id, username, role, schoolId(number|null), status, lastLoginAt(string|null), createdAt"
  create_admin_user_form: "PASS — username, role, schoolId(number|null)"
  school_option: "PASS — id, name"
  page_result: "PASS — {list: T[], total, page, size} matching backend"
  route_meta_roles: "PASS — roles?: number[] in RouteMeta"

api_modules_review:
  admin_user_ts:
    get_list: "GET /core/v1/admin-users with keyword,role,schoolId,page,size → PageResult<AdminUserListItem>"
    create: "POST /core/v1/admin-users with CreateAdminUserForm → number"
  school_ts:
    get_options: "GET /core/v1/schools/options → SchoolOption[]"

ac_coverage:
  total_acs: 5
  fully_verified: 5
  partially_verified: 0
  not_verified: 0
  coverage_rate: 100%
  details:
    - ac_id: AC1
      status: VERIFIED
      method: deep_code_review
      evidence: "el-table 4 columns (username, schoolName mapping, status el-tag, lastLoginAt formatted). role=2 hardcoded. Pagination 10/20/50/100 with total. el-empty. Default page=1 size=10"

    - ac_id: AC2
      status: VERIFIED
      method: deep_code_review
      evidence: "el-input placeholder '请输入手机号搜索'. @click + @keyup.enter + clearable @clear triggers. handleSearch resets page=1"

    - ac_id: AC3
      status: VERIFIED
      method: deep_code_review
      evidence: "el-select clearable placeholder '全部学校'. Options loaded onMounted. @change='handleSearch' resets page=1. Combinable with keyword"

    - ac_id: AC4
      status: VERIFIED
      method: deep_code_review
      evidence: "el-dialog '新增管理员'. Fields: username + schoolId (no name). role=2 auto. Regex ^1[3-9]\\d{9}$. schoolId required. Success: msg + close + refresh"

    - ac_id: AC5
      status: VERIFIED
      method: deep_code_review
      evidence: "No password field in create form. No password column in table. Success message: '创建成功，默认密码为手机号后6位'"

issues:
  critical: 0
  high: 0
  medium: 0
  low: 0
  info_notes:
    - "No backend RBAC (@PreAuthorize) — deferred to Story 2.7, frontend guard only"
    - "No backend unit tests for SchoolController/SchoolService — Maven not available"
    - "SchoolMapper uses static SQL (no parameterized input) — no injection risk"
    - "PageResult type fixed from old {items, pagination} to new {list, total, page, size} matching backend"
    - "router.d.ts augmented with roles?: number[] for TypeScript type safety"

incremental_context:
  cached_risk_level: MEDIUM
  cached_review_mode: deep_code_review
  cached_project_type: crud_management_page
  failed_acs: []
  failed_e2e_scenarios: []
  missing_blind_spots: []
  checkbox_issues: []
