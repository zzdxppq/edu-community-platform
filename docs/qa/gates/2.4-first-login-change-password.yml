story_id: "2.4"
story_title: "首次登录强制修改密码"
review_date: "2026-02-09"
reviewer: "JW (QA Engineer)"
review_round: 1

gate_result: PASS
next_status: Done

risk_assessment:
  risk_level: HIGH
  review_mode: deep_code_review_plus_security
  complexity_indicators: 4
  security_sensitive: true
  notes: "security_complex tier; password change with BCrypt old/new verification; password policy regex; route guard for isFirstLogin; cross frontend+backend (core-service + admin Vue 3)"

project_type:
  type: web_fullstack
  subtype: password_change_flow
  test_runner: code_review_plus_unit_tests

automated_tests:
  verification_method: file_validation_plus_deep_code_review
  total_checks: 28
  passed: 28
  failed: 0
  pass_rate: 100%
  categories:
    file_existence: 12/12
    deliverable_bindings: 7/7
    task_checkboxes: 28/28

unit_test_verification:
  total_test_classes: 1
  total_test_methods: 9
  breakdown:
    AuthServiceImplTest_changePassword: 9
  details:
    - changePassword_shouldSucceed_whenValid
    - changePassword_shouldThrow_whenConfirmMismatch
    - changePassword_shouldThrow_whenUserNotFound
    - changePassword_shouldThrow_whenOldPasswordWrong
    - changePassword_shouldThrow_whenNewSameAsOld
    - changePassword_shouldThrow_whenPolicyViolation_noUppercase
    - changePassword_shouldThrow_whenPolicyViolation_noLowercase
    - changePassword_shouldThrow_whenPolicyViolation_noDigit
    - changePassword_shouldThrow_whenPolicyViolation_tooShort
  note: "No JDK in environment; test code reviewed for correctness, not executed"

deep_file_review:
  new_files_reviewed: 2
  modified_files_reviewed: 10
  total: 12
  categories:
    backend_dto: 1/1
    backend_service_interface: 1/1
    backend_service_impl: 1/1
    backend_controller: 1/1
    backend_mapper: 1/1
    backend_test: 1/1
    frontend_page: 1/1
    frontend_router_routes: 1/1
    frontend_router_guards: 1/1
    frontend_api: 1/1
    frontend_store: 1/1
    frontend_types: 1/1

security_review:
  password_change_flow:
    confirm_match_check: "PASS — confirmPassword == newPassword validated first (line 173-176)"
    old_password_verification: "PASS — passwordEncoder.matches(oldPassword, encodedCurrent) — BCrypt constant-time"
    new_old_comparison: "PASS — passwordEncoder.matches(newPassword, encodedCurrent) detects reuse despite different salts"
    password_policy_regex: "PASS — ^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d).{8,20}$ in both backend and frontend"
    bcrypt_encoding: "PASS — passwordEncoder.encode(newPassword) before storage"
    is_first_login_reset: "PASS — setIsFirstLogin(0) + updateById in same @Transactional"
    validation_order: "PASS — confirm match → find user → old verify → new!=old → policy → update"

  backend_security:
    dto_validation: "PASS — @NotBlank on all 3 fields, @Size(min=8, max=20) on newPassword"
    controller_valid: "PASS — @Valid @RequestBody ChangePasswordRequest"
    user_id_source: "PASS — @RequestHeader('X-User-Id') from Gateway injection (not client input)"
    transactional: "PASS — @Transactional(rollbackFor = Exception.class)"
    mapper_security: "PASS — findByIdWithPassword uses #{id} parameterized query + deleted_at IS NULL"
    no_password_in_response: "PASS — returns Result<Void>, no password field exposed"
    exception_types: "PASS — BusinessException(422) for validation, ResourceNotFoundException(404) for missing user"

  frontend_security:
    dual_validation: "PASS — frontend regex matches backend PASSWORD_PATTERN exactly"
    password_not_logged: "PASS — no console.log of password fields"
    route_guard: "PASS — isFirstLogin=1 blocks all routes except ['/login', '/change-password']"
    guard_order: "PASS — isLoggedIn → isFirstLogin → normal routing"
    state_sync: "PASS — updateIsFirstLogin(0) updates Pinia ref + localStorage via saveUserInfo"
    token_preserved: "PASS — password change does not invalidate JWT (no re-login needed)"

  password_policy:
    min_length: 8
    max_length: 20
    require_uppercase: true
    require_lowercase: true
    require_digit: true
    require_special: false
    regex: "^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d).{8,20}$"
    frontend_backend_parity: "PASS — identical regex in both"

change_password_page_review:
  title: "修改密码"
  subtitle: "首次登录请修改默认密码"
  fields: "oldPassword, newPassword, confirmPassword — all with Lock icon + show-password"
  hint_text: "8-20位，必须包含大写字母、小写字母和数字"
  loading_state: "PASS — :loading on button, try/finally pattern"
  success_flow: "changePasswordApi → updateIsFirstLogin(0) → ElMessage.success → router.push('/dashboard')"
  style: "BlankLayout — gradient(#1a3d6e→#2C5AA0) + white card (matches login page)"

route_guard_review:
  white_list: "['/login', '/change-password']"
  guard_condition: "authStore.user?.isFirstLogin === 1 && !firstLoginWhiteList.includes(to.path)"
  redirect_target: "/change-password"
  route_meta: "{ requiresAuth: true, layout: 'blank' }"
  lazy_load: "() => import('@/views/change-password/index.vue')"
  non_first_login_access: "PASS — isFirstLogin=0 users can still access /change-password voluntarily"

ac_coverage:
  total_acs: 5
  fully_verified: 5
  partially_verified: 0
  not_verified: 0
  coverage_rate: 100%
  details:
    - ac_id: AC1
      status: VERIFIED
      method: deep_code_review
      evidence: "guards.ts: firstLoginWhiteList=['/login','/change-password']; isFirstLogin===1 → redirect /change-password. routes.ts: layout:'blank', requiresAuth:true. Page: title '修改密码', subtitle '首次登录请修改默认密码', BlankLayout gradient"

    - ac_id: AC2
      status: VERIFIED
      method: deep_code_review_plus_security
      evidence: "Backend: PASSWORD_PATTERN=^(?=.*[A-Z])(?=.*[a-z])(?=.*\\d).{8,20}$, @Size(min=8,max=20). Frontend: identical regex + validateNewPassword custom validator. Hint text present. 4 policy violation tests"

    - ac_id: AC3
      status: VERIFIED
      method: deep_code_review_plus_security
      evidence: "AuthServiceImpl: passwordEncoder.matches(newPassword, currentEncoded) → 422 '新密码不能与原密码相同'. Test: changePassword_shouldThrow_whenNewSameAsOld"

    - ac_id: AC4
      status: VERIFIED
      method: deep_code_review_plus_security
      evidence: "Backend: encode(newPassword) + setIsFirstLogin(0) + updateById in @Transactional. Frontend: updateIsFirstLogin(0) → Pinia+localStorage sync → ElMessage.success → push('/dashboard'). Test: changePassword_shouldSucceed_whenValid verifies isFirstLogin=0"

    - ac_id: AC5
      status: VERIFIED
      method: deep_code_review
      evidence: "guards.ts: global beforeEach, firstLoginWhiteList, isFirstLogin===1 check before normal routing. isFirstLogin=0 users not blocked. Page refresh: state persisted via localStorage (Story 2.3)"

issues:
  critical: 0
  high: 0
  medium: 0
  low: 0
  info_notes:
    - "Maven/JDK runtime verification deferred — no JDK in current environment"
    - "ESLint not configured — lint check skipped"
    - "Password history check (history_count:5 per security.md) not implemented — documented as future requirement per BR-3.2"
    - "Token not invalidated after password change — by design per BR-4.4 (JWT self-contained)"
    - "Backend does not enforce isFirstLogin route restriction — pure frontend guard per BR-5.4"
    - "findByIdWithPassword uses SELECT * — acceptable for single-row fetch with password field needed"

incremental_context:
  cached_risk_level: HIGH
  cached_review_mode: deep_code_review_plus_security
  cached_project_type: password_change_flow
  failed_acs: []
  failed_e2e_scenarios: []
  missing_blind_spots: []
  checkbox_issues: []
